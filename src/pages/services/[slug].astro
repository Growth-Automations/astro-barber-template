---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import ServiceDetailHero from '../../components/sections/ServiceDetailHero.astro';
import ServiceProcess from '../../components/sections/ServiceProcess.astro';
import { getSiteSettings } from '../../lib/site';

export async function getStaticPaths() {
  const services = await getCollection('services');
  return services.map((service) => ({
    params: { slug: service.data.slug },
    props: { service }
  }));
}

const { service } = Astro.props;
const pageTitle = `${service.data.title} | Services`;
const siteSettings = await getSiteSettings();
const { phone } = siteSettings.contact;

const primaryCtaLabel = service.data.ctaLabel ?? 'Book this service';
const primaryCtaHref = `/appointment?service=${service.data.slug}`;
const secondaryCta = phone
  ? {
      label: 'Call the shop',
      href: `tel:${phone.value}`
    }
  : undefined;

const processTitle = service.data.processTitle ?? `How ${service.data.title} works`;
const processDescription = service.data.processDescription;
const processSteps = service.data.processSteps ?? [];
const processImage = service.data.processImage ?? service.data.image;
---

<BaseLayout title={pageTitle} description={service.data.summary}>
  <ServiceDetailHero
    eyebrow="Service detail"
    title={service.data.title}
    summary={service.data.summary}
    category={service.data.category}
    duration={service.data.duration}
    price={service.data.price}
    highlight={service.data.highlight}
    image={service.data.image}
    primaryCta={{ label: primaryCtaLabel, href: primaryCtaHref }}
    secondaryCta={secondaryCta}
  />

  <section class="bg-white py-20 text-text-primary">
    <div class="mx-auto grid max-w-6xl gap-12 px-4 sm:px-6 lg:grid-cols-[1.1fr_0.9fr] lg:px-8">
      <article class="space-y-6">
        <h2 class="text-2xl font-semibold text-text-primary md:text-3xl">What to expect</h2>
        <p class="text-lg leading-relaxed text-text-secondary">{service.data.description}</p>
        {processSteps.length === 0 && (
          <p class="rounded-2xl border border-dashed border-border bg-surface-alt px-4 py-3 text-sm text-text-muted">
            We&apos;re finalizing the detailed step-by-step experience for this service.
          </p>
        )}
      </article>
      <aside class="space-y-6">
        <div class="rounded-3xl border border-border bg-surface-alt p-6 shadow-sm">
          <p class="text-xs font-semibold uppercase tracking-[0.35em] text-text-muted">Plan your visit</p>
          <h3 class="mt-2 text-xl font-semibold text-text-primary">Book this experience</h3>
          <p class="mt-3 text-sm text-text-secondary">
            Share preferred dates and styling notes. Our concierge matches you with the right barber or on-location team.
          </p>
          {(service.data.duration || service.data.price || service.data.highlight) && (
            <dl class="mt-5 grid gap-4 text-sm text-text-secondary sm:grid-cols-2">
              {service.data.duration && (
                <div>
                  <dt class="text-[0.65rem] font-semibold uppercase tracking-[0.3em] text-text-muted">Duration</dt>
                  <dd class="mt-1 text-lg font-semibold text-text-primary">{service.data.duration}</dd>
                </div>
              )}
              {service.data.price && (
                <div>
                  <dt class="text-[0.65rem] font-semibold uppercase tracking-[0.3em] text-text-muted">Investment</dt>
                  <dd class="mt-1 text-lg font-semibold text-text-primary">{service.data.price}</dd>
                </div>
              )}
              {service.data.highlight && (
                <div class="sm:col-span-2 rounded-2xl border border-primary/20 bg-primary/5 px-4 py-3 text-sm text-text-secondary">
                  {service.data.highlight}
                </div>
              )}
            </dl>
          )}
          <div class="mt-6 flex flex-col gap-3 sm:flex-row">
            <a class="btn btn-primary w-full" href={primaryCtaHref}>{primaryCtaLabel}</a>
            {secondaryCta && (
              <a class="btn btn-outline w-full" href={secondaryCta.href}>
                {secondaryCta.label}
              </a>
            )}
          </div>
        </div>
        <div class="rounded-3xl border border-border bg-white p-6 text-sm text-text-secondary shadow-sm">
          <p class="text-base font-semibold text-text-primary">Questions before you book?</p>
          <p class="mt-2">
            Email <a class="text-primary underline-offset-2 hover:underline" href={`mailto:${siteSettings.contact.email}`}>
              {siteSettings.contact.email}
            </a>{' '}
            or call us during shop hours. We&apos;re happy to recommend add-ons or bundle services.
          </p>
        </div>
      </aside>
    </div>
  </section>

  {processSteps.length > 0 && (
    <ServiceProcess
      eyebrow="The experience"
      title={processTitle}
      description={processDescription}
      steps={processSteps}
      image={processImage}
    />
  )}
</BaseLayout>
