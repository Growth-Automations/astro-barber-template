---
import type { NavigationLink, ContactInfo } from '../../lib/types';
import ThemeToggle from './ThemeToggle.astro';

export interface Props {
  siteName: string;
  navigation: NavigationLink[];
  contact: ContactInfo;
  currentPath?: string;
}

const { siteName, navigation, contact, currentPath = Astro.url?.pathname ?? '/' } = Astro.props as Props;
const navItems = navigation.some((item) => item.href === '/shop')
  ? navigation
  : [...navigation, { label: 'Shop', href: '/shop' }];
---

<header class="fixed inset-x-0 top-0 z-50 border-b border-border/10 bg-background/80 backdrop-blur">
  <div class="mx-auto flex max-w-7xl items-center px-4 py-4 text-sm sm:px-6 lg:px-8">
    <a
      class="shrink-0 text-lg font-semibold text-primary hover:text-primary-light"
      href="/"
      data-astro-prefetch
    >
      {siteName}
    </a>
    <nav class="hidden flex-1 items-center justify-center gap-6 font-medium text-text-secondary md:flex">
      {navItems.map((item) => (
        <a
          class={`whitespace-nowrap transition-colors hover:text-primary ${currentPath === item.href ? 'text-primary' : ''}`}
          href={item.href}
          data-astro-prefetch
        >
          {item.label}
        </a>
      ))}
    </nav>
    <div class="flex shrink-0 items-center gap-3">
      <a
        class="hidden whitespace-nowrap text-text-secondary hover:text-primary lg:inline-flex"
        href={`tel:${contact.phone.value}`}
      >
        {contact.phone.display}
      </a>
      <ThemeToggle />
      <a class="btn btn-primary whitespace-nowrap" href="/contact" data-astro-prefetch>
        Book appointment
      </a>
      <!-- Mobile menu button -->
      <button
        id="mobile-menu-button"
        type="button"
        class="inline-flex items-center justify-center rounded-md p-2 text-text-secondary hover:bg-surface-alt hover:text-text focus:outline-none focus:ring-2 focus:ring-primary md:hidden"
        aria-expanded="false"
        aria-controls="mobile-menu"
        aria-label="Toggle menu"
      >
        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path class="menu-open" stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
          <path class="menu-close hidden" stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
  </div>

  <!-- Mobile menu -->
  <div
    id="mobile-menu"
    class="hidden border-t border-border/10 bg-background/95 backdrop-blur md:hidden"
    style="top: var(--header-height, 73px)"
  >
    <nav class="flex flex-col space-y-1 px-4 py-4">
      {navItems.map((item) => (
        <a
          class={`rounded-md px-3 py-2 text-base font-medium transition-colors hover:bg-surface-alt hover:text-primary ${currentPath === item.href ? 'bg-surface-alt text-primary' : 'text-text-secondary'}`}
          href={item.href}
          data-astro-prefetch
        >
          {item.label}
        </a>
      ))}
    </nav>
  </div>
</header>

<!-- Spacer for fixed header -->
<div id="header-spacer" style="height: var(--header-height, 73px)"></div>

<script>
  function debounce<T extends (...args: unknown[]) => void>(fn: T, delay: number): T {
    let timeout: ReturnType<typeof setTimeout>;
    return ((...args: Parameters<T>) => {
      clearTimeout(timeout);
      timeout = setTimeout(() => fn(...args), delay);
    }) as T;
  }

  function updateHeaderHeight() {
    const header = document.querySelector('header');
    if (header) {
      const height = header.offsetHeight;
      document.documentElement.style.setProperty('--header-height', `${height}px`);
    }
  }

  function initMobileMenu() {
    const button = document.getElementById('mobile-menu-button');
    const menu = document.getElementById('mobile-menu');
    const openIcon = button?.querySelector('.menu-open');
    const closeIcon = button?.querySelector('.menu-close');

    if (!button || !menu) return;

    button.addEventListener('click', () => {
      const isOpen = menu.classList.toggle('hidden');
      button.setAttribute('aria-expanded', String(!isOpen));
      openIcon?.classList.toggle('hidden');
      closeIcon?.classList.toggle('hidden');
    });

    // Close menu on navigation
    menu.querySelectorAll('a').forEach((link) => {
      link.addEventListener('click', () => {
        menu.classList.add('hidden');
        button.setAttribute('aria-expanded', 'false');
        openIcon?.classList.remove('hidden');
        closeIcon?.classList.add('hidden');
      });
    });
  }

  // Initialize
  updateHeaderHeight();
  initMobileMenu();

  // Update on resize (debounced)
  window.addEventListener('resize', debounce(updateHeaderHeight, 150));

  // Update after fonts load
  document.fonts?.ready.then(updateHeaderHeight);
</script>
