---
import type { CollectionEntry } from 'astro:content';
import ServiceCard from './ServiceCard.astro';
import { resolveAsset } from '../../lib/assets';

export interface Props {
  services: CollectionEntry<'services'>[];
  eyebrow?: string;
  heading?: string;
  subheading?: string;
  backgroundWord?: string;
  highlightFirst?: boolean;
  cta?: { label: string; href: string };
}

const {
  services,
  eyebrow,
  heading = 'Core services',
  subheading,
  backgroundWord = 'SERVICES',
  highlightFirst = false,
  cta
} = Astro.props as Props;

const carouselId = `services-${Math.random().toString(36).slice(2, 8)}`;
const bgImage = resolveAsset('~/assets/images/photos/barber_grooming_tools.jpg');
---

<section class="relative overflow-hidden bg-surface-alt py-24">
  {/* Background image with barber arranging grooming tools */}
  <div class="absolute inset-0 h-full w-full">
    <img
      class="h-full w-full object-cover object-center opacity-20"
      src={bgImage}
      alt="Barber arranging grooming tools and products on counter"
      loading="lazy"
    />
  </div>

  {/* Transparent overlays for content separation */}
  <div class="pointer-events-none absolute inset-0">
    {/* Overlay */}
    <div class="absolute inset-0 bg-background/30" />

    {/* Decorative circles */}
    <div class="absolute -top-10 right-16 h-32 w-32 rounded-full border border-white/10" />
    <div class="absolute bottom-10 left-10 h-24 w-24 rounded-full border border-white/10" />
  </div>

  <div class="relative mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
    <div class="flex flex-col gap-6 text-center">
      {eyebrow && <p class="text-xs font-semibold uppercase tracking-[0.45em] text-accent">{eyebrow}</p>}
      <div class="mx-auto max-w-3xl">
        <h2 class="font-heading text-3xl font-bold tracking-tight text-text-primary md:text-4xl lg:text-5xl">
          {heading}
        </h2>
        {subheading && <p class="mt-4 text-lg font-medium leading-relaxed text-text-secondary">{subheading}</p>}
      </div>
      {cta && (
        <div class="mt-2">
          <a class="inline-flex items-center gap-2 text-sm font-semibold uppercase tracking-[0.35em] text-primary transition hover:text-primary-light dark:hover:text-primary-light" href={cta.href}>
            {cta.label} →
          </a>
        </div>
      )}
    </div>

    {/* Carousel Container */}
    <div class="mt-16 flex items-center justify-between gap-4">
      {/* Previous Button */}
      <button
        class="hidden h-12 w-12 shrink-0 items-center justify-center rounded-full border-2 border-border bg-surface text-2xl text-text-primary shadow-md transition-all duration-300 hover:scale-110 hover:border-primary hover:bg-primary hover:text-on-primary hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-primary/50 md:inline-flex"
        type="button"
        aria-label="Previous service"
        data-prev
      >
        <span aria-hidden="true">‹</span>
      </button>

      {/* Carousel Track */}
      <div class="relative flex-1 overflow-hidden">
        <ul
          id={carouselId}
          class="flex snap-x snap-mandatory gap-6 overflow-x-auto pb-4 pt-2 scrollbar-hide"
          data-services-carousel
          data-track
        >
          {services.map((service, index) => (
            <li class="min-w-[90%] snap-center sm:min-w-[calc(50%-12px)] lg:min-w-[calc(33.333%-16px)]">
              <ServiceCard service={service} index={index} highlight={highlightFirst && index === 0} />
            </li>
          ))}
        </ul>
      </div>

      {/* Next Button */}
      <button
        class="hidden h-12 w-12 shrink-0 items-center justify-center rounded-full border-2 border-border bg-surface text-2xl text-text-primary shadow-md transition-all duration-300 hover:scale-110 hover:border-primary hover:bg-primary hover:text-on-primary hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-primary/50 md:inline-flex"
        type="button"
        aria-label="Next service"
        data-next
      >
        <span aria-hidden="true">›</span>
      </button>
    </div>

    {/* Carousel Dots */}
    <div class="mt-8 flex justify-center gap-3" data-dots>
      {services.map((_, index) => (
        <button
          class={`h-3 w-3 rounded-full border-2 transition-all duration-300 hover:scale-125 ${
            index === 0
              ? 'border-primary bg-primary shadow-md shadow-primary/40'
              : 'border-border bg-transparent hover:border-primary/50'
          }`}
          type="button"
          aria-label={`Go to service ${index + 1}`}
          data-dot
          data-index={index}
        />
      ))}
    </div>
  </div>
</section>

<style is:global>
  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }
  .scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
</style>

<script>
  const carouselRoot = document.currentScript?.previousElementSibling?.previousElementSibling?.closest('section');
  const container = carouselRoot?.querySelector('[data-services-carousel]');
  if (container) {
    const prevButton = carouselRoot.querySelector('[data-prev]');
    const nextButton = carouselRoot.querySelector('[data-next]');
    const dots = Array.from(carouselRoot.querySelectorAll('[data-dot]'));
    const slides = Array.from(container.children);

    const scrollToIndex = (index: number) => {
      const target = slides[index];
      if (!target) return;
      target.scrollIntoView({ behavior: 'smooth', inline: 'center' });
      dots.forEach((dot, dotIndex) => {
        dot.classList.toggle('bg-primary', dotIndex === index);
        dot.classList.toggle('border-primary', dotIndex === index);
        dot.classList.toggle('shadow-md', dotIndex === index);
        dot.classList.toggle('shadow-primary/40', dotIndex === index);
        dot.classList.toggle('bg-transparent', dotIndex !== index);
        dot.classList.toggle('border-border', dotIndex !== index);
      });
      container.setAttribute('data-active-index', String(index));
    };

    const getActiveIndex = () => {
      const current = Number(container.getAttribute('data-active-index') ?? '0');
      return Number.isNaN(current) ? 0 : current;
    };

    prevButton?.addEventListener('click', () => {
      const nextIndex = (getActiveIndex() - 1 + slides.length) % slides.length;
      scrollToIndex(nextIndex);
    });

    nextButton?.addEventListener('click', () => {
      const nextIndex = (getActiveIndex() + 1) % slides.length;
      scrollToIndex(nextIndex);
    });

    dots.forEach((dot, index) => {
      dot.addEventListener('click', () => scrollToIndex(index));
    });

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            const currentIndex = slides.indexOf(entry.target as Element);
            if (currentIndex >= 0) {
              dots.forEach((dot, dotIndex) => {
                dot.classList.toggle('bg-primary', dotIndex === currentIndex);
                dot.classList.toggle('border-primary', dotIndex === currentIndex);
                dot.classList.toggle('shadow-md', dotIndex === currentIndex);
                dot.classList.toggle('shadow-primary/40', dotIndex === currentIndex);
                dot.classList.toggle('bg-transparent', dotIndex !== currentIndex);
                dot.classList.toggle('border-border', dotIndex !== currentIndex);
              });
              container.setAttribute('data-active-index', String(currentIndex));
            }
          }
        });
      },
      { root: container, threshold: 0.5 }
    );

    slides.forEach((slide) => observer.observe(slide));
    container.setAttribute('data-active-index', '0');
  }
</script>
